<!DOCTYPE html>
<html>
	<head>
		<title>Emmet</title>
	</head>
	<body>
    <!--https://docs.emmet.io/-->
    <!--dl>p.item$*5>div^^a*2+(header>ul>li*2>a)-->
    <!--p.item$*5>div^a*2+(header>ul>li*2>a)-->
    <!--(p.item>div^a*2+(header>ul>li*2>a))+(p.item>div^a*2+(header>ul>li*2>a))+(p.item>div^a*2+(header>ul>li*2>a))+(p.item>div^a*2+(header>ul>li*2>a))+(p.item>div^a*2+(header>ul>li*2>a))-->
    <!--(p.item>div^a*2+(header>ul>li*2>a))+(p.item>div^a*2+(header>ul>li*2>a))+(p.item>div^a*2+(header>ul>li*2>a))+(p.item>div^a*2+(header>ul>li*2>a))+(p.item>div^a*2+(header>ul>li*2>a))-->
		<script type="text/javascript">
			function emmet(str) {
                const d = document, ac = 'appendChild', lc = 'lastChild', ctn = 'createTextNode', ss = 'substr', lth = 'length', rpc = 'replace';

                // t for text, a for attr, g for group, c for cal, l for level, tg for tag
                const tokenRegex = /(?<t>{.+?})|(?<a>\[.+?\])|(?<g>\(.+?\))|(?<c>[\$\@\-\d]*\*\d+)|(?<l>[\>\+\^]+)|(?<tg>[a-z1-6]+)/gi;

                str = str[rpc](/([#\.])([^+>*^.\[]*)/gi, function(rs, g1, g2){
                    return '[' + g1[rpc]('.','class')[rpc]('#','id') + '="' + g2 + '"]'
                }); // 将#id和.class替换为[]属性

                let tree = d.createDocumentFragment(), currentNode = tree, curToken, preToken;

                while((curToken = tokenRegex.exec(str)) !== null){
                    let g = curToken.groups, t = curToken[0];

                    if(g.t){ // 文本标签
                        if(preToken && preToken.groups.tg){ // 上个token为标签
                            currentNode[lc][ac](d[ctn](t[ss](1, t[lth] - 2)));
                        }else{
                            currentNode[ac](d[ctn](t[ss](1, t[lth] - 2)));
                        }
                    }else if(g.g){ // 分组
                        let gFrag = emmet(t[ss](1, t[lth] - 2));
                        currentNode[ac](gFrag);
                    }else if(g.c){

                    }else if(g.l){ // 树层级控制
                        if(g.l == '>'){
                            currentNode = currentNode[lc];
                        }else if(g.l == '^'){
                            currentNode = currentNode.parentNode;
                        }
                    }else if(g.tg){ // 非文本标签
                        currentNode[ac](d.createElement(t));
                    }else if(g.a){ // 属性
                        let kvStr = t[ss](1, t[lth] - 2).split(/[\'\"]+ /gi);
                        for(let i = 0; i < kvStr[lth]; i++){
                            let kv = kvStr[i].split('=');
                            currentNode[lc].setAttribute(kv[0], kv[1][rpc](/[\"\']/gi, ''));
                        }
                    }

                    preToken = curToken;
                }

                return tree;
			}

			console.log(emmet('div.divClass>span{i am span}^p+(h1>span{span in group})+div#divId[title="title" class="class1 class2"]'));//div>(header>ul>li*2>a)+footer>p$*5>div+span+span{i am span}
		</script>
	</body>
</html>